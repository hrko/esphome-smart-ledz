#pragma once

#ifdef USE_ESP32

#include <array>
#include <cstddef>
#include <cstdint>

namespace esphome {
namespace smart_ledz {

struct CtRgbEntry {
  uint16_t kelvin;
  uint8_t red;
  uint8_t green;
  uint8_t blue;
};

template <size_t N>
inline std::array<uint8_t, 3> lookup_ct_rgb_from_table(const std::array<CtRgbEntry, N> &table, uint16_t kelvin) {
  if (kelvin <= table.front().kelvin) {
    return {table.front().red, table.front().green, table.front().blue};
  }
  if (kelvin >= table.back().kelvin) {
    return {table.back().red, table.back().green, table.back().blue};
  }
  for (size_t i = 0; i + 1 < N; i++) {
    const auto &a = table[i];
    const auto &b = table[i + 1];
    if (a.kelvin <= kelvin && kelvin <= b.kelvin) {
      if (a.kelvin == b.kelvin) {
        return {a.red, a.green, a.blue};
      }
      const float t = float(kelvin - a.kelvin) / float(b.kelvin - a.kelvin);
      const uint8_t red = static_cast<uint8_t>(a.red + (b.red - a.red) * t + 0.5f);
      const uint8_t green = static_cast<uint8_t>(a.green + (b.green - a.green) * t + 0.5f);
      const uint8_t blue = static_cast<uint8_t>(a.blue + (b.blue - a.blue) * t + 0.5f);
      return {red, green, blue};
    }
  }
  return {table.back().red, table.back().green, table.back().blue};
}

inline constexpr std::array<CtRgbEntry, 55> CT_RGB_DUV_0 = {{
    {1800, 246, 64, 0},
    {1900, 230, 79, 0},
    {2000, 217, 93, 0},
    {2100, 205, 103, 2},
    {2200, 194, 111, 5},
    {2300, 183, 119, 8},
    {2400, 174, 125, 11},
    {2500, 164, 131, 14},
    {2600, 156, 136, 18},
    {2700, 148, 140, 22},
    {2800, 141, 143, 26},
    {2900, 134, 146, 30},
    {3000, 127, 148, 34},
    {3100, 121, 150, 38},
    {3200, 115, 152, 42},
    {3300, 110, 153, 46},
    {3400, 105, 154, 51},
    {3500, 100, 154, 55},
    {3600, 96, 154, 59},
    {3700, 92, 154, 64},
    {3800, 88, 153, 68},
    {3900, 85, 153, 72},
    {4000, 82, 152, 77},
    {4100, 79, 150, 81},
    {4200, 76, 149, 85},
    {4300, 73, 147, 89},
    {4400, 71, 145, 93},
    {4500, 69, 144, 98},
    {4600, 66, 142, 102},
    {4700, 64, 140, 106},
    {4800, 62, 138, 109},
    {4900, 61, 136, 113},
    {5000, 59, 134, 117},
    {5100, 57, 132, 121},
    {5200, 56, 129, 124},
    {5300, 55, 127, 128},
    {5400, 53, 125, 132},
    {5500, 52, 122, 135},
    {5600, 51, 120, 138},
    {5700, 50, 118, 142},
    {5800, 49, 115, 145},
    {5900, 48, 113, 148},
    {6000, 47, 111, 151},
    {6500, 44, 100, 166},
    {7000, 42, 89, 179},
    {7500, 40, 79, 191},
    {8000, 39, 69, 202},
    {8500, 38, 61, 211},
    {9000, 37, 53, 220},
    {9500, 37, 45, 227},
    {10000, 37, 39, 234},
    {10500, 37, 33, 240},
    {11000, 37, 27, 245},
    {11500, 37, 23, 250},
    {12000, 37, 18, 255},
}};

inline constexpr std::array<CtRgbEntry, 55> CT_RGB_DUV_6 = {{
    {1800, 251, 59, 0},
    {1900, 236, 74, 0},
    {2000, 221, 89, 0},
    {2100, 206, 103, 0},
    {2200, 191, 118, 0},
    {2300, 179, 131, 0},
    {2400, 166, 144, 0},
    {2500, 153, 156, 1},
    {2600, 144, 161, 5},
    {2700, 135, 166, 8},
    {2800, 127, 170, 12},
    {2900, 120, 173, 16},
    {3000, 113, 176, 21},
    {3100, 106, 179, 25},
    {3200, 100, 181, 29},
    {3300, 95, 182, 33},
    {3400, 89, 183, 37},
    {3500, 84, 184, 42},
    {3600, 79, 184, 46},
    {3700, 75, 184, 50},
    {3800, 71, 184, 55},
    {3900, 67, 183, 59},
    {4000, 64, 182, 64},
    {4100, 60, 181, 68},
    {4200, 57, 180, 72},
    {4300, 55, 178, 77},
    {4400, 52, 176, 81},
    {4500, 50, 175, 85},
    {4600, 47, 173, 90},
    {4700, 45, 171, 94},
    {4800, 43, 169, 98},
    {4900, 41, 167, 102},
    {5000, 39, 165, 106},
    {5100, 37, 162, 110},
    {5200, 36, 160, 114},
    {5300, 35, 157, 118},
    {5400, 33, 155, 121},
    {5500, 32, 153, 125},
    {5600, 30, 151, 129},
    {5700, 29, 148, 132},
    {5800, 28, 146, 136},
    {5900, 27, 143, 139},
    {6000, 26, 141, 143},
    {6500, 22, 129, 158},
    {7000, 20, 117, 173},
    {7500, 18, 106, 186},
    {8000, 16, 96, 197},
    {8500, 15, 87, 208},
    {9000, 15, 78, 217},
    {9500, 15, 70, 225},
    {10000, 14, 63, 233},
    {10500, 14, 56, 239},
    {11000, 14, 50, 245},
    {11500, 14, 45, 251},
    {12000, 14, 40, 255},
}};

inline constexpr std::array<CtRgbEntry, 55> CT_RGB_DUV_3 = {{
    {1800, 249, 61, 0},
    {1900, 233, 77, 0},
    {2000, 219, 90, 0},
    {2100, 203, 106, 0},
    {2200, 191, 118, 0},
    {2300, 178, 130, 1},
    {2400, 168, 137, 4},
    {2500, 159, 143, 8},
    {2600, 150, 148, 11},
    {2700, 142, 153, 15},
    {2800, 134, 157, 19},
    {2900, 127, 160, 23},
    {3000, 120, 162, 27},
    {3100, 114, 164, 31},
    {3200, 108, 166, 36},
    {3300, 102, 168, 40},
    {3400, 97, 169, 44},
    {3500, 92, 169, 48},
    {3600, 88, 169, 53},
    {3700, 84, 169, 57},
    {3800, 80, 169, 61},
    {3900, 76, 168, 66},
    {4000, 73, 167, 70},
    {4100, 69, 166, 74},
    {4200, 67, 164, 79},
    {4300, 64, 162, 83},
    {4400, 61, 161, 87},
    {4500, 59, 159, 92},
    {4600, 57, 157, 96},
    {4700, 55, 155, 100},
    {4800, 53, 153, 104},
    {4900, 51, 151, 108},
    {5000, 49, 149, 112},
    {5100, 47, 147, 115},
    {5200, 46, 145, 119},
    {5300, 45, 142, 123},
    {5400, 43, 140, 127},
    {5500, 42, 138, 130},
    {5600, 41, 135, 134},
    {5700, 40, 133, 137},
    {5800, 39, 130, 140},
    {5900, 38, 128, 144},
    {6000, 37, 126, 147},
    {6500, 33, 114, 162},
    {7000, 31, 103, 176},
    {7500, 29, 92, 188},
    {8000, 28, 82, 200},
    {8500, 27, 73, 210},
    {9000, 26, 65, 218},
    {9500, 26, 57, 226},
    {10000, 26, 51, 233},
    {10500, 25, 44, 240},
    {11000, 26, 39, 245},
    {11500, 26, 34, 251},
    {12000, 26, 29, 255},
}};

inline constexpr std::array<CtRgbEntry, 55> CT_RGB_DUV_m3 = {{
    {1800, 245, 63, 2},
    {1900, 233, 74, 3},
    {2000, 221, 83, 6},
    {2100, 209, 92, 8},
    {2200, 198, 100, 11},
    {2300, 188, 107, 14},
    {2400, 179, 113, 17},
    {2500, 170, 119, 21},
    {2600, 162, 123, 25},
    {2700, 154, 127, 28},
    {2800, 147, 130, 32},
    {2900, 140, 133, 37},
    {3000, 134, 135, 41},
    {3100, 128, 136, 45},
    {3200, 123, 138, 49},
    {3300, 118, 139, 53},
    {3400, 113, 139, 57},
    {3500, 109, 139, 62},
    {3600, 104, 139, 66},
    {3700, 101, 139, 70},
    {3800, 97, 138, 74},
    {3900, 94, 137, 79},
    {4000, 90, 136, 83},
    {4100, 88, 135, 87},
    {4200, 85, 134, 91},
    {4300, 83, 132, 95},
    {4400, 80, 130, 99},
    {4500, 78, 128, 103},
    {4600, 76, 127, 107},
    {4700, 74, 125, 111},
    {4800, 72, 123, 115},
    {4900, 70, 121, 119},
    {5000, 69, 119, 122},
    {5100, 67, 117, 126},
    {5200, 66, 114, 129},
    {5300, 65, 112, 133},
    {5400, 64, 110, 136},
    {5500, 62, 108, 140},
    {5600, 61, 106, 143},
    {5700, 60, 103, 146},
    {5800, 60, 101, 149},
    {5900, 59, 99, 152},
    {6000, 58, 97, 155},
    {6500, 55, 86, 169},
    {7000, 52, 75, 182},
    {7500, 51, 66, 193},
    {8000, 50, 56, 204},
    {8500, 49, 48, 213},
    {9000, 48, 41, 221},
    {9500, 48, 34, 228},
    {10000, 48, 28, 234},
    {10500, 48, 22, 240},
    {11000, 48, 17, 245},
    {11500, 48, 12, 250},
    {12000, 48, 7, 254},
}};

inline constexpr std::array<CtRgbEntry, 55> CT_RGB_DUV_m6 = {{
    {1800, 248, 54, 7},
    {1900, 236, 64, 9},
    {2000, 225, 74, 12},
    {2100, 214, 82, 14},
    {2200, 203, 89, 17},
    {2300, 193, 96, 20},
    {2400, 184, 102, 24},
    {2500, 176, 107, 27},
    {2600, 168, 111, 31},
    {2700, 160, 114, 35},
    {2800, 153, 117, 39},
    {2900, 147, 119, 43},
    {3000, 141, 121, 47},
    {3100, 136, 123, 52},
    {3200, 130, 124, 56},
    {3300, 125, 124, 60},
    {3400, 121, 125, 64},
    {3500, 117, 125, 68},
    {3600, 113, 125, 72},
    {3700, 109, 124, 77},
    {3800, 105, 123, 81},
    {3900, 102, 122, 85},
    {4000, 99, 121, 89},
    {4100, 96, 120, 93},
    {4200, 94, 119, 97},
    {4300, 92, 117, 101},
    {4400, 89, 115, 105},
    {4500, 87, 113, 109},
    {4600, 85, 112, 113},
    {4700, 83, 110, 116},
    {4800, 82, 108, 120},
    {4900, 80, 106, 124},
    {5000, 79, 104, 127},
    {5100, 77, 102, 131},
    {5200, 76, 100, 134},
    {5300, 75, 97, 138},
    {5400, 74, 95, 141},
    {5500, 72, 93, 144},
    {5600, 71, 91, 147},
    {5700, 70, 89, 150},
    {5800, 70, 87, 153},
    {5900, 69, 85, 156},
    {6000, 68, 83, 159},
    {6500, 65, 72, 173},
    {7000, 63, 62, 185},
    {7500, 61, 53, 196},
    {8000, 60, 44, 205},
    {8500, 59, 37, 214},
    {9000, 59, 29, 221},
    {9500, 59, 23, 228},
    {10000, 59, 17, 234},
    {10500, 58, 11, 240},
    {11000, 59, 6, 244},
    {11500, 56, 4, 250},
    {12000, 53, 2, 255},
}};

inline std::array<uint8_t, 3> lookup_ct_rgb(uint16_t kelvin, int8_t duv) {
  switch (duv) {
    case 6:
      return lookup_ct_rgb_from_table(CT_RGB_DUV_6, kelvin);
    case 3:
      return lookup_ct_rgb_from_table(CT_RGB_DUV_3, kelvin);
    case -3:
      return lookup_ct_rgb_from_table(CT_RGB_DUV_m3, kelvin);
    case -6:
      return lookup_ct_rgb_from_table(CT_RGB_DUV_m6, kelvin);
    case 0:
    default:
      return lookup_ct_rgb_from_table(CT_RGB_DUV_0, kelvin);
  }
}

}  // namespace smart_ledz
}  // namespace esphome

#endif
